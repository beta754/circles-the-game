name: Infra Up
run-name: ${{ github.actor }} is creating all the things ðŸš€
on:
  - push
  - workflow_dispatch
jobs:
  Terraform:
    runs-on: ubuntu-latest
    environment: primary
    env:
      DIGITALOCEAN_TOKEN: ${{ secrets.DO_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.TFBE_ACESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.TFBE_ACCESS_KEY_SECRET }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - uses: ./.github/actions/tf_init.yaml
        id: init
        with:
          REGION: nyc3
          S3_ENDPOINT: https://nyc3.digitaloceanspaces.com
          S3_BUCKET: ctg-tfstate
          S3_STATE_KEY: "terraform.tfstate"
          WORKING_DIRECTORY: .infra
      - name: plan
        shell: pwsh
        working-directory: ".infra"
        env:
          TFVARS_FILE: ${{ steps.init.TF_VARS }}
        run: terraform plan -out=tfplan -var-file="$env:TFVARS_FILE"
      - name: apply
        if: github.ref == 'refs/heads/master'
        shell: pwsh
        working-directory: ".infra"
        run: |
          terraform apply tfplan
